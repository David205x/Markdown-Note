## 8.25 绪论
- 成绩占比
	- `70%` 期末闭卷考核(限制参考资料)
	- `10%` 考勤课堂表现
	- `10%` 作业(一次大作业·)
	- `10%` 实验(包含报告)
	
- 嵌入式系统
	
	> 完全嵌入受控器内部，为特定应用设计的专用计算机系统
	
- 嵌入式微处理器
	> 只保留和嵌入式应用紧密相关的功能硬件，追求最低的功耗和资源实现特殊要求 
	



## 第一章 嵌入式微处理器概述
### 1.1 无处不在的嵌入式系统
- 嵌入式系统
	- 定义[^ 用于**控制**、**监视**或者**辅助**操作机器和设备的<u>装置</u>]
	> 区别于通用计算机系统
	- 理想[^ 无感]
	- 发展
	- 特点：特定应用,技术/资金密集,高度分散,不断创新,高效设计,生命周期较长,不具备自开发能力
	- 应用

### 1.2 微处理器的发展过程



## 第二章 
### 2.1 指令集架构概述
> 程序员看到的计算机的属性，即概念性结构与功能特性

- 指令集架构`ISA`[^处理器底层硬件与运行于其上的软件之间的桥梁和接口，区分的**主要**标准]
### 2.2 CSIC与RISC
#### CSIC[^台式计算机系统的典型体系]

- 指令系统庞大
- 指定功能复杂
- 指令执行使用多周期(较慢)
- 指令的2/8定律

#### RISC[^大大改善了处理器的性能]

- 精简指令目录和寻址方式
- 并行执行友好(采用流水线技术)
- 指令格式一致
- 指令周期相同



### 2.4 嵌入式微处理器的基本组成

- CPU的四个基本元素

  - 存储架构：存储数据和程序的方法
  - ALU：执行逻辑操作的方法
  - 总线结构：信息传输的方法
  - 控制单元：让这一系列指令能够具体化为操作和传输的方法

- 储存架构

  - 可被计算机访问的方式储存
  - 储存器中储存到条目需要一个**能够访问到位置**，即**地址**
  - CPU的变成用最低级的机器代码完成，程序是按特定序列排列的**指令簇**

  > 典型的嵌入式微处理器储存架构
  >
  > - 寄存器[^ 断电易失]：存储程序的临时变量、计数器、状态信息、返回地址、堆栈指针等
  > - RAM[^ 断电易失]：存放对战、变量、待处理的数据，**临时储存位置**
  > - 非易失性存储器：存储要执行的程序

- ARM v4 7个基本工作模式

  - User用户模式：一般的非特权任务运行模式
  - FIQ快中断模式：高优先级中断，高速数据传输和
  -  IRQ中断模式：次优先级中断
  - Supervisor特权模式：
  - Abort异常模式：存取异常进入
  - Undef未定义模式：执行未定义指令时进入
  - System系统模式 ：使用和User模式相同的寄存器，权限高于User

- 存储单元

- 算术逻辑单元

- 总线结构[^ 信息的公共通路]

  - 按照计算机所传输的信息种类：数据总线、地址总线、控制总线
  - 根据所连接对象的不同：器件级(内部)总线[^ 部件内部]、系统总线[^ COU 与计算机内部高速组件]、I/O(外部)总线 
  - AMBA总线系统：ARM核需要某种接口核其他与案件进行通信，包括AHB ASB APB

- 控制单元[^ 保证 取指-指令译码-指令执行-写回结果(非必要) 步骤按正确顺序执行]

  - 替代控制策略

    - 分布式控制
    - 自定时控制
    - 增加规律性(简化)

  - 异常控制策略

    > 中断探测时间[^ 发生时刻-能做出相应时刻]
    >
    > 中断响应时间[^ 开始服务时刻-最坏情况所有动作完成时刻]
    >
    > 最小中断时间[^ 一个中断发生时刻-该中断可再次发生时刻]

    - 中断事件通知处理器
    - CPU完成正在进行的工作
    - 转入终端服务例程
    - 中断重定向[^ 将中断向量重新映射道储存器的零i一个地址空间]
      - 高级中断处理
      - 共享中断



## 第三章 RISC-V

### 3.1 简介

- 基于RISC原理建立的开放指令集架构
- 允许任何人设计、制造和销售RISC-V芯片和软件

### 3.2 设计哲学

- 大道至简：通过架构定义使硬件的实现足够简单
  - 后发优势：有效规避体系发展过程中各种问题，不存在**向后兼容**的问题

### 3.3 指令集架构简介

- 模块化指令子集
- 可配置的通用寄存器组
- 规整的指令编码
- 简洁的存储器访问指令
- 高效的分支跳转指令

### 总结比较

- 硬件设计希望指令集尽可能规整、简单
- 极低功耗与低面积
- 储存器资源比早期处理器更丰富

### 3.4 RISC-V工具链

### 3.5 典型的RISC-V处理器

#### 蜂鸟E200



## 第四章 流水线

### 4.2状态机和流水线的选择

- 状态机和流水线是性能与面积上的取舍
- 流水线在各模块存在相关性时冲突，状态机即没有该问题

### 4.3 流水线冲突[^ 某些情况下，下一条指令无法按照预期开始执行]

- 资源冲突[^ 硬件部件还在为之前指令工作]
- 数据冲突[^ 某数据因该数据正被之前指令操作]
  - 数据冒险
    - 流水线停顿增加气泡；数据前递，增加复杂度
  - 控制冒险[^ 尚未确定是否发生分支，如何进行下一次取指]
    - 流水线停顿增加气泡；预测分支
- 控制冲突[^ 之前指令的结果还没产生]

### 4.3 取指单元及其实现[^ 快、连续不断]

- 取指特点

  - 非分支跳转指令：连续不断按顺序从储存器快速读取，不对齐的32位指令

    ​							   也应能够连续不断地每个周期读出一条完整指令

  - 分支跳转指令：快速判断是否需要跳转，若需跳转则从新PC快速读取指令，

    ​								不对齐的32位指令也应快速连续不断完整

- 快速取指

  - 指令紧耦合存储器ITCM

    - 配置较小容量SRAM存储指令，物理上离核近且专属于处理器核
    - 优点：实现简单，容易理解，能保持实时性
    - 缺点：无法映射无限大的存储空间，仅用来存储大小有限的关键程序指令

  - 指令缓存I-Cache

    - 利用软件的时间、空间局部性，动态映射外部指令到容量有限的指令缓存中，

    - 优点：平均延迟降低到最小

    - 缺点：访问存在不确定性，不命中则造成较长延迟，无法保证最可靠的实时性

      ​			为处理器微架构中最复杂的部分

- 处理非对齐指令

  - 普通指令非对齐：剩余缓存保存上次取指后没用完的比特位
  - 分支跳转指令非对齐：多体化SRAM[^ 交错存储连续的数据以保证读取方便]，资源开销大

- 处理分支指令

  - 无条件跳转分支：无需判断条件，一定会发生的
    - 无条件直接跳转分支：指令编码中的立即数计算再跳转
    - 无条件间接跳转分支：
  - 带条件跳转分支(RISC-V不支持)
  - 分支预测技术
    - 预测方向：是否需要跳转
      - 静态：仅依靠分支指令本身信息进行预测
        - 总预测不会发生跳转：冲刷流水线，分支延迟槽
        - BTFN预测：向后的预测为跳，向前的预测不跳
      - 动态：依赖已执行过的指令的历史信息和分支指令本身信息(RISC-V不支持)
        - 一级预测器
        - 二级预测器
    - 预测地址：如果跳转，目标地址是什么
      - 分支目标缓存BTB：
        - 有限缓存保存最近执行过分支指令PC和跳转目标，后续PC匹配时判断为分支并存储跳转地址
        - 简单快捷，容量受限，简介跳转/分支指令效果不理想
      - 间接BTB：
        - 以大硬件开销换取较高的预测成功率
      - 返回地址堆栈RAS
        - 优先的对战存储函数调用的返回地址
        - 成对调用较好，函数嵌套时不稳定
    - 预测取值：使用预测的方向地址的取指行为
  - RISC-V取指优化
    - 指令长度指示码位于低位
    - 提供明确的静态分支预测依据

  ### 4.5 执行单元及其实现

  - 指令执行概述
  - 指令执行：根据具体操作类型将指令内容发射给具体的运算单元进行执行(分配任务)
  - 发射/派遣[^ 译码后的指令被派发到不同运行单元执行]、执行、写回的顺序
    - 高端处理器中：
      - 派遣：译码后的指令派发到不同运算单元的等待队列中的过程
      - 发射：指令从运算单元等待队列中(解决了数据依赖中)发射到运算单元开始执行的过程
    - 顺序发射，顺序执行，顺序写回：性能低，硬件实现最简单，面积最小
    - 顺序发射，乱序执行，顺序写回：执行时允许执行不同的指令，等待其他单元先歇会而停滞自身流水线
