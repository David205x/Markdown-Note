# L20 内存使用与分段
### 内存如何工作
- 内存使用：程序放在内存中，PC指向开始地址（程序执行）
### 程序进入内存
- 逻辑地址：程序中的地址以相对地址形式记录，基址为程序自身入口，称为**逻辑地址**
- 程序想要进入内存进而执行，必然面临**逻辑地址**到**物理地址**的转换
- 让逻辑地址直接对应物理内存中的地址是不现实的：
  - 物理内存的0地址不能随便用，那里放的是操作系统
  - 其他程序也要用同一段地址，发生冲突了
##### 重定位
- 找一段空闲内存，然后将**逻辑地址**转换为相应的**物理地址**
- 程序载入后的移动：闲置的进程进入磁盘等待，将内存空出给其他进程使用，称为**交换**，此时也涉及重定位。
##### 何时重定位
- 编译时：程序只能放在固定位置，要求程序运行对应内存就必须预留，这使得重定位比较困难。更高效，多用于嵌入式系统
- 载入时：程序在内存中的位置动态决定。载入的过程需要时间，载入之后就不能移动了。比较灵活，多用于通用性系统
- **运行时**：运行每条指令时才完成重定位（地址翻译）：物理地址=基地址+逻辑地址偏移。
  - 基址：基址信息放在**PCB**中，当前进程的基址放在**基址寄存器**中，进程switch时做出相应恢复现场和保护现场操作（CPU-内存层面）。
  - 操作系统还要支持**交换**（内存-外部储存层面），综上**运行时重定位**是最佳时机。

### 内存分段
- 程序由若干部分（段）组成，每段有各自的特点与用途，应当采用分治思想：
  - 代码段只读，数据段可写
  - 代码段/数据段不会动态增长
- 各段分别放入内存，而非将整个程序放入内存
- 寻址：段基址+端内偏移
##### GDT与LDT
- 有了段的概念，就要求记录段的信息：段基址、段限长...
- GDT是操作系统的段表
- LDT是每个进程的段表
  - LDT表中的每一项都是一个段的信息
  - 当前段的表示：ldtr寄存器指向LDT表中的一项
  - LDT表存储在进程的PCB中，进程切换则LDT表切换
  - 程序每段指令地址翻译时，所需各段的基址参考LDT表，进而重定位到物理地址